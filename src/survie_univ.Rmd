---
title: "Survie univariee"
output:
  word_document: default
  html_notebook: default
---


```{r allsource, echo=FALSE, message=FALSE}
.dir <- "F:/"
#.dir <-  "d:/"
source(paste0(.dir,"to push/sla_git/src/libraries_SLA.R"))
source(paste0(.dir,"to push/sla_git/src/fonctions_SLA.R"))
```


```{r, echo=FALSE}
sla <- readRDS(paste0(.dir,"to push/sla_git/data/BASE_SLA_allbl.rds"))

sla$rilu <- ifelse (sla$DEBRILU < sla$DATEVNI & (is.na(sla$FINRILU) | sla$FINRILU>sla$DATEVNI), 1, 0) #je fais l'hyp qu'il n'y a pas de NA

sla$keep <- ifelse (sla$DATEVNI<=sla$ddn,1,0)

sla <- sla[sla$keep==1, ]
sla$time.vni <- as.numeric(sla$ddn - sla$DATEVNI)
sla$time.sym <- as.numeric(sla$ddn - sla$FIRSTSYMPTOM)
sla$censor <- ifelse (!is.na(sla$date_dc),1, 0)
#sla$sex <- factor(sla$sex_def, levels=c(1,2), labels=c("h","f") ) #1 = 'Masculin' 2 = 'Feminin'
sla$sex <- ifelse(sla$sex_def==1,0,sla$sex_def) #0 = 'Masculin' 1 = 'Feminin'
sla$sex <- ifelse(sla$sex_def==2,1,sla$sex) #0 = 'Masculin' 1 = 'Feminin'
#sla$sex <- sla$sex_def #1 = 'Masculin' 2 = 'Feminin'
sla$agevni <- round(as.numeric(sla$DATEVNI-sla$DOB)/365.25,0)
sla$rilu <- ifelse(sla$DATEVNI>sla$DEBRILU & !is.na(sla$DEBRILU), 1,0)
sla$rilu <- ifelse(sla$DATEVNI<sla$FINRILU & !is.na(sla$FINRILU), 0,sla$rilu)
sla$familial <- ifelse (is.na(sla$familial),0,sla$familial)
sla$LIEUDEB_recode <- as.factor(sla$LIEUDEB_recode)
#sla$ddn <- ifelse(sla$ddn>as_date("2015-08-27"), as_date("2015-08-27"), sla$ddn) #voir avec Yann

var_bl <- c("familial", "sex", "agevni", "LIEUDEB_recode", "rilu", "dysp","orthop","CVF_ASSIS_perc_pred","CVF_COUCHE_perc_pred","SNIP_cmH2O",
  "SNIP_perc_pred","PIMAX_cmH2O","PIMAX_perc_pred","perc_time_under_spo2_90","time_under_spo2_90_h","bicar","ALS_score","bulb_score")

var_quali <- c("familial", "sex", "LIEUDEB_recode", "rilu", "dysp", "orthop")
var_quanti <- var_bl [! var_bl %in% var_quali]

sla[,var_quanti] <- apply(sla[,var_quanti], 2, function(x) as.numeric(x))
sla[,var_quali[!var_quali%in% "LIEUDEB_recode"]] <- apply(sla[,var_quali[!var_quali%in% "LIEUDEB_recode"]], 2, function(x) as.numeric(x))

#summary(sla)
#str(sla)
```

#Description de la population 
```{r, echo=FALSE}
table_var_quali <- lapply(var_quali, function(i){
  data <- sla[,i]
  names_levels <- levels(as.factor(data))
  a <- lapply(names_levels, function(x) {
    tmp <- as.numeric(table(data)[x])
    tmpbis <- round(as.numeric(prop.table(table(data))[x]),3)*100
    tmptot <- paste0(tmp," (",tmpbis,"%)")
    
    nNA <- table(is.na(data))
    pNA <- round(prop.table(table(is.na(data))),3)
    if (is.na(nNA[2]))  {
      if (which(names_levels==x)==1) nNA <- paste0 (0," (0%)")
      else nNA <- ""
    }
    else {
      if (which(names_levels==x)==1){
        nNA <- as.numeric (nNA[names(nNA)==TRUE])
        pNA <- as.numeric (pNA[names(pNA)==TRUE])*100
        nNA <- paste0(nNA," (",pNA,"%)")  
      }
      else nNA <- ""
    }
    cbind(tmptot,nNA)
      
  })
  a <- do.call(rbind,a)
  #a <- cbind (a,nNA)
  rownames(a) <- paste0(i,"_",names_levels) 
  colnames(a) <- c("valeur","missing values")
  # a <- rbind (a,nNA)
  # rownames(a)[-nrow(a)] <- paste0(i,"_",names_levels) 
  return(a)
})
table_var_quali <- do.call(rbind,table_var_quali)

table_var_quanti <- lapply(var_quanti, function(i){ #median ou moyenne? (sachant qu'on ne verifie pas normalite des baselines)
  data <- sla[,i]
  med <- round(median (data,na.rm=T),2)
  quant <- round(quantile(data,na.rm=T),2)
  Q1 <- quant[2]
  Q3 <- quant[4]
  a <- paste0(med," (",Q1,"-",Q3,")")
  #browser()

  nNA <- table(is.na(data))
  pNA <- round(prop.table(table(is.na(data))),3)
  if (is.na(nNA[2]))  nNA <- paste0 (0," (0%)")
  else {
    nNA <- as.numeric (nNA[names(nNA)==TRUE])
    pNA <- as.numeric (pNA[names(pNA)==TRUE])*100
    nNA <- paste0(nNA," (",pNA,"%)")
  }
  # a <- rbind (a,nNA)
  # rownames(a)[-nrow(a)] <- paste0(i,"*") 
  a <- cbind (a,nNA)
  rownames(a) <- paste0(i,"*")
  colnames(a) <- c("valeur","missing values")
  return(a)
})
table_var_quanti <- do.call(rbind,table_var_quanti)

table_var <- rbind(table_var_quali,table_var_quanti)
kable(table_var)

```

Table 1 Characteristiques a baseline (t=debut de la vni)
*variables quantitatives

<1% de donnees manquantes pour :   
- familial(atcd familiaux de sla oui ou non)   
- sex  
- lieu de debut des symptomes  
- a commence un traitement par riluzole avant vni oui ou non  
- age a l'instauration de la vni   

Environ 30% de donnees manquantes pour :    
- le score ALS a l'instauration de la VNI  

Environ 50 % de donnees manquantes pour :  
- orthopnee au moment de l'instauration de la vni  
- dyspnee au moment de l'instauration de la vni   

Plus de 65% de donnees manquantes pour :  
- CVF assis et couche   
- SNIP en cmH20 ou pourcentage de la theorie   
- PIMAX en cmH20 ou pourcentage de la theorie  
- pourcentage de temps inferieur a 90% de sp02  
- bicarbonates   
- score bulbaire  

64% d'homme   
98% de formes non familiales  
7% de traitement par riluzole  
plus de 50% d'orthopnee mais moins de 25% de dyspnee au repos.  


#VERSION DEBUT = PREMIERS SYMPTOMES


##Suivi global

```{r, echo=FALSE}
#range date de debut
deb1 <- range(sla$FIRSTSYMPTOM,na.rm=T)

#repartition des dates de premier symptome
s<-sla[!is.na(sla$time.sym),]
s$tan<-s$time.sym/365.25
s$an<-substring(s$FIRSTSYMPTOM, 1, 4)
#table(s$an)
barplot(table(s$an))
```

Fig.1 Distribution des dates de premier symptome

```{r}
y<-as.numeric(as.Date("01/09/2015", "%d/%m/%Y"))-as.numeric(s$FIRSTSYMPTOM)
hist(y/365.25)
#summary(y/365.25)
```
Fig.2 repartition des duree de suivi

range date de debut :  
`r deb1`

La majorite des sujets sont inclus a partir de 2006 (9ans de recul) et quasiment plus d'unclusion en 2011 (4 ans de recul) (Figure 1)

```{r, echo=FALSE, message=FALSE}
#suivi
sym.suiv <- survfit(Surv(time.sym,1-censor)~1,data=s)
an <- paste0 (round(summary(sym.suiv)$table['median']/365.25,2)," [",round(summary(sym.suiv)$table['0.95LCL']/365.25,2),"-",round(summary(sym.suiv)$table['0.95UCL']/365.25,2),"]")

# #idem (Yann)
# suivi<-survfit(Surv(tan, 1-censor)~1, data=s)
# suivi


```
Mediane de suivi (an) : `r an`   

C'est coherent au vu de la figure 1 et de la figure 2.


## Survie globale
```{r, echo=FALSE}
sym.surv <- survfit(Surv(time.sym,censor)~1, data=s, conf.int=.95)

an <- paste0 (round(summary(sym.surv)$table['median']/365.25,2)," [", round(summary(sym.surv)$table['0.95LCL']/365.25,2), "-", round(summary(sym.surv)$table['0.95UCL']/365.25,2),"]")

plot(sym.surv,xscale=365.25, yscale= 100, xlab="time (years)")
ggsurv(sym.surv) +#https://www.r-bloggers.com/survival-plots-have-never-been-so-informative/
  scale_x_continuous(breaks=seq(0,max(s$time.sym),365.25), labels=0:(length(seq(0,max(s$time.sym),365.25))-1)) +
  scale_y_continuous(labels=percent) 
```


Fig.3 Courbe de survie en fonction du temps 


Mediane de survie (an) : `r an`





#VERSION DEBUT = MISE EN PLACE VNI

##Suivi global

```{r, echo=FALSE}


#repartition des dates de premier symptome
s<-sla[!is.na(sla$time.vni),]
s$tan<-s$time.vni/365.25
s$an<-substring(s$DATEVNI, 1, 4)
#table(s$an)
barplot(table(s$an))
```

Fig.4 Distribution de la date d'instauration de la vni

Centre autour de 2010. majorite des vni entre 2008 et 2012 donc entre 7 ans et 3 ans de recul.


```{r}
#range date de debut
deb1 <- range(sla$DATEVNI,na.rm=T)

y<-as.numeric(as.Date("01/09/2015", "%d/%m/%Y"))-as.numeric(s$DATEVNI)
hist(y/365.25)
#summary(y/365.25)
```
Fig.5 repartition des duree de suivi

range date de debut :  
`r deb1`


```{r, echo=FALSE, message=FALSE}
#suivi
sym.suiv <- survfit(Surv(time.vni,1-censor)~1,data=s)
an <- paste0 (round(summary(sym.suiv)$table['median']/365.25,2)," [",round(summary(sym.suiv)$table['0.95LCL']/365.25,2),"-",round(summary(sym.suiv)$table['0.95UCL']/365.25,2),"]")

# #idem (Yann)
# suivi<-survfit(Surv(tan, 1-censor)~1, data=s)
# suivi


```
Mediane de suivi (an) : `r an`   

C'est un peu etrange que la mediane de suivi soit si basse, au vu des figures 4 et 5 j'aurais plutÃ´t parie sur une mediane de suivi a 4.5 ans.


## Survie globale
```{r, echo=FALSE}
sym.surv <- survfit(Surv(time.vni,censor)~1, data=s, conf.int=.95)

an <- paste0 (round(summary(sym.surv)$table['median']/365.25,2)," [", round(summary(sym.surv)$table['0.95LCL']/365.25,2), "-", round(summary(sym.surv)$table['0.95UCL']/365.25,2),"]")

#plot(sym.surv,xscale=365.25, yscale= 100, xlab="time (years)")

s<-sla
s$tps<-s$time.vni/365.25
km <- survfit(Surv(tps,censor)~1, data=s, conf.int=.95)
skmi<-summary(km, time=c(3, 6)) #pour IC95%
skm<-summary(km, time=seq(0, 10, by=1)) #pour table survie
skm <- data.frame(time=skm$time, n.risk=skm$n.risk)
skm

g <- ggsurv(km, CI=FALSE) +
  scale_x_continuous(breaks=seq(0,max(s$time.vni),1), labels=0:(length(seq(0,max(s$time.vni),1))-1)) +
  scale_y_continuous(labels=percent) +
  theme(legend.position="bottom", legend.title=element_blank()) +
  theme(plot.margin = unit(c(1,1,3,1), "cm")) +
  labs(x="Time of follow-up, year")
#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi$time[i], y = skmi$lower[i], xend = skmi$time[i], yend = skmi$upper[i])
   g <- g + geom_segment(x = skmi$time[i] - 0.1, y = skmi$lower[i], xend = skmi$time[i] + 0.1, yend = skmi$lower[i])
   g <- g + geom_segment(x = skmi$time[i] - 0.1, y = skmi$upper[i], xend = skmi$time[i] + 0.1, yend = skmi$upper[i])
}
#risk table
for (ii in 1:nrow(skm)) {
  g <- g + annotation_custom(grob = textGrob(skm$n.risk[ii]), xmin = skm$time[ii], xmax = skm$time[ii], ymin= - 1.3 )

  # #display group text
  # if (ii %in% c(1,4)) #there is probably a better way
  # {
  #   p1=p1+ annotation_custom(grob = textGrob(skm$group[ii]),
  #                            xmin = 0.85,
  #                            xmax = 0.85,
  #                            ymin = skm$ypos[ii],
  #                            ymax = skm$ypos[ii])
  # }

}
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)

# ggsurv(sym.surv) +#https://www.r-bloggers.com/survival-plots-have-never-been-so-informative/
#   scale_x_continuous(breaks=seq(0,max(s$time.vni),365.25), labels=0:(length(seq(0,max(s$time.vni),365.25))-1)) +
#   scale_y_continuous(labels=percent) 
```

Fig.3 Courbe de survie en fonction du temps 


Mediane de survie (an) : `r an`

```{r, echo=FALSE, eval=FALSE}
#--------------------------
#Yann : rajout de table de survie et d'intervalle de confiance a la main 

#VERSION MODELE VIDE
s<-sla
s$tps<-s$time.vni/365.25
km <- survfit(Surv(tps,censor)~1, data=s, conf.int=.95)
skmi<-summary(km, time=c(3, 6)) #pour IC95%
skm<-summary(km, time=seq(0, 10, by=1)) #pour table survie
skm

#preparation de la fenetre de plot : conserve de l'espace autour du plot
par(mai=c(2,1.5,1.5,.5)) 
#plot sans l'intervalle de confiance
  plot(km, conf.int=F, col="blue")
#intervalle de confiance a 3 et 6 ans
  #barre vertical
  segments(skmi$time, skmi$lower, skmi$time, skmi$upper, col="blue")
  #lower
  segments(skmi$time-0.1, skmi$lower, skmi$time+0.1, skmi$lower, col="blue") #-0.1 et +0.1 pour tracer traits horizontaux
  #upper
  segments(skmi$time-0.1, skmi$upper, skmi$time+0.1, skmi$upper, col="blue") #-0.1 et +0.1 pour tracer traits horizontaux
#table de survie
    mtext(side=1, at=skm$time, skm$n.risk, adj=.5, col="blue", line=2, cex=0.75)


#VERSION 1 COVARIABLE
s<-sla
s$tps<-s$time.vni/365.25
#courbe de KM
km <- survfit(Surv(tps,censor)~sex, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==1,], conf.int=.95)
km
#pour IC95%
skmi0<-summary(km0, time=c(3, 6)-0.1)
skmi1<-summary(km1, time=c(3, 6)+0.1)
#pour table de survie
skm0<-summary(km0, time=seq(0, 10, by=1))
skm1<-summary(km1, time=seq(0, 10, by=1))
skm

#preparation legende
leg<-names(km$strata)
coul<-c("blue", "red")
#prepapration fenetre
par(mai=c(2,1.5,1.5,.5))

#plot
  plot(km, conf.int = F, col = coul)
  #legende
  legend("topright", adj=0, col=coul, leg=leg, lty=1)
  #trait vertical pour sex=0
  segments(skmi0$time, skmi0$lower, skmi0$time, skmi0$upp, col=coul[1])
  segments(skmi0$time-0.1, skmi0$lower, skmi0$time+0.1, skmi0$lower, col="blue")
  segments(skmi0$time-0.1, skmi0$upper, skmi0$time+0.1, skmi0$upper, col="blue")
  #trait vertical pour sex=1
  segments(skmi1$time, skmi1$lower, skmi1$time, skmi1$upp, col=coul[2])
  segments(skmi1$time-0.1, skmi1$lower, skmi1$time+0.1, skmi1$lower, col="red") #-0.1 et +0.1 pour tracer traits horizontaux
  segments(skmi1$time-0.1, skmi1$upper, skmi1$time+0.1, skmi1$upper, col="red") #-0.1 et +0.1 pour tracer traits horizontaux
#table de survie
  #sex=0
  mtext(side=1, at=-0.7, leg[1], col=coul[1], line=2)
  mtext(side=1, at=skm0$time, skm0$n.risk, adj=.5, col=coul[1], line=2, cex=0.75)
  #sex=1
  mtext(side=1, at=-0.7, leg[2], col=coul[2], line=2)
  mtext(side=1, at=skm1$time, skm1$n.risk, adj=.5, col=coul[2], line=3, cex=0.75)
#-----------------
```



## Modeles de Cox univarie

Ils seront de la forme 
modcox <- coxph(Surv(time.vni, censor) ~ ALS_score, data = sla) #ALS_score au autre variable baseline

un modele par variable a baseline

NB : on ne verifiera l'hypothese de loglinearite que pour les variables quantiatives
On ne fera de courbes de survie que pour les variables binaires et qualitatives non ordonnees.

### Familial

#### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$familial
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
z <- cox.zph(mod, transform = "rank")
z
```

La representation graphique des residus de shoenfeld est non significatif.  
Le test de Harrell est non significatif.  

Conclusion : l'hypothese des risques proportionnels est verifiee.

#### Interpretation
```{r, echo=FALSE}
summary(mod)
```

Je peux donc en deduire que les individus avec un antecedent familial ont un risque de deces multiplie par 2.5  (test du score p<0.05)

```{r}
var <- "familial"
km <- survfit(Surv(tps,censor)~familial, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~familial, data=s[s$familial==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~familial, data=s[s$familial==1,], conf.int=.95)

#pour IC95%
#skmi0<-summary(km0, time=c(3, 6)-0.1)
skmi0<-summary(km0, time=c(0.5, 1)-0.1)
#skmi1<-summary(km1, time=c(3, 6)+0.1)
skmi1<-summary(km1, time=c(0.5, 1)+0.1) #plus d'Ã©vÃ¨nement apres 1.94 ans

#pour table de survie
skm0 <- summary(km0, time=seq(0, 10, by=1))
skm0 <- data.frame(time=skm0$time, n.risk=skm0$n.risk)
skm1<-summary(km1, time=seq(0, 10, by=1))
skm1 <- data.frame(time=skm1$time, n.risk=skm1$n.risk)


#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend=FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete(breaks = c(0,1), labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(1,1,3,1), "cm")) 

#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi0$time[i], y = skmi0$lower[i], xend = skmi0$time[i], yend = skmi0$upper[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$lower[i], xend = skmi0$time[i] + 0.1, yend = skmi0$lower[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$upper[i], xend = skmi0$time[i] + 0.1, yend = skmi0$upper[i])
}
for (i in 1:2) {
   g <- g + geom_segment(x = skmi1$time[i], y = skmi1$lower[i], xend = skmi1$time[i], yend = skmi1$upper[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$lower[i], xend = skmi1$time[i] + 0.1, yend = skmi1$lower[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$upper[i], xend = skmi1$time[i] + 0.1, yend = skmi1$upper[i])
}

#risk table
for (ii in 1:nrow(skm0)) {
  g <- g + annotation_custom(grob = textGrob(skm0$n.risk[ii]), xmin = skm0$time[ii], xmax = skm0$time[ii], ymin= - 1.5 )
}  
for (ii in 1:nrow(skm1)) {
  g <- g + annotation_custom(grob = textGrob(skm1$n.risk[ii]), xmin = skm1$time[ii], xmax = skm1$time[ii], ymin= - 1.7 )
} 
  #display group text
  g <- g + annotation_custom(grob = textGrob(leg[1]), xmin = -1.7, xmax = -1.7, ymin= - 1.5 )
  g <- g + annotation_custom(grob = textGrob(leg[2]), xmin = -1.7, xmax = -1.7, ymin= - 1.7 )
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)


```


### Sexe

#### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$sex
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

L'hypothese Nulle de risque proportionnel est rejetee par methode graphique (pas par le test) entre 6 mois et 1 an et demi environ.  

Je dois rajouter une variable dependante du temps.

##### Log

```{r, echo=FALSE}
#----- Log -----
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
slat$at <- slat$a_recode * log(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

at est significatif, la correction est peut etre bonne.  
Donc je reverifie l'hypothese des risques proportionnels

```{r, echo=FALSE}
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
plot(zt[1])
abline(h=0, col="red")
#abline(h=coef(coxt)[1], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Je ne comprends pas le schema. J'ai 2 schema, je lis lequel? La courbe est lineaire centree sur 0 mais droite h=0 pas exactement dans l'IC.
Test significatif mais je lis quelle ligne?

##### sqrt

```{r, echo=FALSE}
#------ sqrt------
slat$at <- slat$a_recode * sqrt(slat$stop)
slat$at1 <- slat$a_recode * ifelse(slat$stop<1, slat$stop, 0) #valeur de la covariable quand tps<1
slat$at2 <- slat$a_recode * ifelse(slat$stop>=1, 1, 0)        #valeur de la covariable qd tps>=1

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
#coxt <- coxph(Surv(start, stop, censor) ~ at1+at2, data=slat)
summary(coxt)$coefficients

#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```
plot a peu pres ok...
mais test de harrell significatif pour a_recode et at


##### 1/t
```{r, echo=FALSE}
#--------1/t-----------
slat$at <- slat$a_recode/(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```
ne fitte pas

##### t
```{r, echo=FALSE}
#----- t -----
slat$at<-slat$a_recode*(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Fitte moins bien que sqrt

Donc finalement c'est la racine carree qui fitte le mieux.

#### InterprÃ©tation
```{r, echo=FALSE}
slat$at <- slat$a_recode * sqrt(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)

S <- vcov(coxt)
b <- coef(coxt)
t <- 1
f <- sqrt
var <- S[1,1]+S[2,2]*f(t)^2+2*S[1,2]*f(t)
m <- b[1]+b[2]*f(t)
HR <- round(exp(m),3)
IC <- round(exp(m + qnorm(0.975,m,sqrt(var))*sqrt(var) * c(-1,1)),3)
#IC <- round(exp(m + qnorm(0.975)*sqrt(var) * c(-1,1)),3) #version automatique

#qnorm(c(0.025,0.975), m, sqrt(var)) ??

paste0("HR[95%IC] = ",HR, " [", IC[1], "-", IC[2], "] ", "pour t = ", t, " an" )
```

Je peux donc en deduire que les femmes(a_recode=1) ont un risque de deces significativement different (a_recode signif) multiplie par :  
- HR = exp(beta(a_recode))= 1,151 a t0  IC=[1.146-1.156] : version calcul a la main
- HR = exp(beta(a_recode) + beta(at) x f(t)) = exp(0.139 + 0.308 * sqrt(1)) = 1.563 a 1 an IC = [1.553-1.572]

Pourquoi l'IC est plus etroit pour t=0 quand on calcule a la main vs lecture de summary? (1,151[1.100-1.204] vs 1.151[1.146-1.156])
parce que le logiciel prend zalpha/2 = 1.96 (qnorm(0.975,0,1))  alors que je prends 0.19 (qnorm(0.975, b[1]+b[2]*f(t), sqrt(var)))


```{r, message=FALSE}
var <- "Sexe"
km <- survfit(Surv(tps,censor)~sex, data=s, conf.int=.95)
#km <- survfit(Surv(start, stop, censor) ~ a_recode + at, data=slat)
km0 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==1,], conf.int=.95)

#pour IC95%
skmi0<-summary(km0, time=c(3, 6)-0.1)
#skmi0<-summary(km0, time=c(0.5, 1)-0.1)
skmi1<-summary(km1, time=c(3, 6)+0.1)
#skmi1<-summary(km1, time=c(0.5, 1)+0.1) #plus d'Ã©vÃ¨nement apres 1.94 ans

#pour table de survie
skm0 <- summary(km0, time=seq(0, 10, by=1))
skm0 <- data.frame(time=skm0$time, n.risk=skm0$n.risk)
skm1<-summary(km1, time=seq(0, 10, by=1))
skm1 <- data.frame(time=skm1$time, n.risk=skm1$n.risk)


#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend=FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete( labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(1,1,3,1), "cm")) 

#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi0$time[i], y = skmi0$lower[i], xend = skmi0$time[i], yend = skmi0$upper[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$lower[i], xend = skmi0$time[i] + 0.1, yend = skmi0$lower[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$upper[i], xend = skmi0$time[i] + 0.1, yend = skmi0$upper[i])
}
for (i in 1:2) {
   g <- g + geom_segment(x = skmi1$time[i], y = skmi1$lower[i], xend = skmi1$time[i], yend = skmi1$upper[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$lower[i], xend = skmi1$time[i] + 0.1, yend = skmi1$lower[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$upper[i], xend = skmi1$time[i] + 0.1, yend = skmi1$upper[i])
}

#risk table
for (ii in 1:nrow(skm0)) {
  g <- g + annotation_custom(grob = textGrob(skm0$n.risk[ii]), xmin = skm0$time[ii], xmax = skm0$time[ii], ymin= - 1.5 )
}  
for (ii in 1:nrow(skm1)) {
  g <- g + annotation_custom(grob = textGrob(skm1$n.risk[ii]), xmin = skm1$time[ii], xmax = skm1$time[ii], ymin= - 1.7 )
} 
  #display group text
  g <- g + annotation_custom(grob = textGrob(leg[1]), xmin = -1.7, xmax = -1.7, ymin= - 1.5 )
  g <- g + annotation_custom(grob = textGrob(leg[2]), xmin = -1.7, xmax = -1.7, ymin= - 1.7 )
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)
```


### Riluzole
#### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$rilu
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```
L'hypothese des risques proportionnels est verifie (p>0.05), je peux interpreter

#### Interpretation
```{r}
summary(mod)
```
Le risque de deces n'est pas significativement different selon que les individus sont traites ou non par riluzole. (test du score p=0.848)

```{r, message=FALSE}
var <- "Riluzole"
km <- survfit(Surv(tps,censor)~rilu, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~rilu, data=s[s$rilu==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~rilu, data=s[s$rilu==1,], conf.int=.95)

#pour IC95%
skmi0<-summary(km0, time=c(3, 6)-0.1)
#skmi0<-summary(km0, time=c(0.5, 1)-0.1)
skmi1<-summary(km1, time=c(3, 6)+0.1)
#skmi1<-summary(km1, time=c(0.5, 1)+0.1) #plus d'Ã©vÃ¨nement apres 1.94 ans

#pour table de survie
skm0 <- summary(km0, time=seq(0, 10, by=1))
skm0 <- data.frame(time=skm0$time, n.risk=skm0$n.risk)
skm1<-summary(km1, time=seq(0, 10, by=1))
skm1 <- data.frame(time=skm1$time, n.risk=skm1$n.risk)


#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend = FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete( labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(1,1,3,1), "cm")) 

#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi0$time[i], y = skmi0$lower[i], xend = skmi0$time[i], yend = skmi0$upper[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$lower[i], xend = skmi0$time[i] + 0.1, yend = skmi0$lower[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$upper[i], xend = skmi0$time[i] + 0.1, yend = skmi0$upper[i])
}
for (i in 1:2) {
   g <- g + geom_segment(x = skmi1$time[i], y = skmi1$lower[i], xend = skmi1$time[i], yend = skmi1$upper[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$lower[i], xend = skmi1$time[i] + 0.1, yend = skmi1$lower[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$upper[i], xend = skmi1$time[i] + 0.1, yend = skmi1$upper[i])
}

#risk table
for (ii in 1:nrow(skm0)) {
  g <- g + annotation_custom(grob = textGrob(skm0$n.risk[ii]), xmin = skm0$time[ii], xmax = skm0$time[ii], ymin= - 1.5 )
}  
for (ii in 1:nrow(skm1)) {
  g <- g + annotation_custom(grob = textGrob(skm1$n.risk[ii]), xmin = skm1$time[ii], xmax = skm1$time[ii], ymin= - 1.7 )
} 
  #display group text
  g <- g + annotation_custom(grob = textGrob(leg[1]), xmin = -1.7, xmax = -1.7, ymin= - 1.5 )
  g <- g + annotation_custom(grob = textGrob(leg[2]), xmin = -1.7, xmax = -1.7, ymin= - 1.7 )
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)
```

### Dyspnee de repos
#### Hypothese des risques proportionnels

```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$dysp
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

Significatif de 0 a 6 mois environ. J'ajoute une variable dependante du temps.

###### Log
```{r, echo=FALSE}
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
slat$at <- slat$a_recode * log(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

at significatif avec log, je reverifie HRR

```{r, echo=FALSE}
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Le log correspond : courbe a peu pres ok et test ok

#### InterprÃ©tation

```{r, echo=FALSE}
summary(coxt)
```

```{r, echo=FALSE, eval=FALSE}
S <- vcov(coxt)
b <- coef(coxt)
t <- 1
f <- sqrt
var <- S[1,1]+S[2,2]*f(t)^2+2*S[1,2]*f(t)
m <- b[1]+b[2]*f(t)
HR <- round(exp(m),3)
IC <- round(exp(m + qnorm(0.975,m,sqrt(var))*sqrt(var) * c(-1,1)),3)
#IC <- round(exp(m + qnorm(0.975)*sqrt(var) * c(-1,1)),3) #version mean=0, sd=1

#qnorm(c(0.025,0.975), m, sqrt(var)) ??

paste0("HR[95%IC] = ",HR, " [", IC[1], "-", IC[2], "] ", "pour t = ", t, " an" )

```

Le risque de deces n'est pas significativement different (test du score p>=0.05) selon que le patient ait ou non une dyspnee de repos a l'instauration de la vni.  

```{r, echo=FALSE, message=FALSE}
var <- "Dyspnee de repos"
km <- survfit(Surv(tps,censor)~dysp, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~dysp, data=s[s$dysp==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~dysp, data=s[s$dysp==1,], conf.int=.95)

#pour IC95%
#skmi0<-summary(km0, time=c(3, 6)-0.1)
skmi0<-summary(km0, time=c(1, 3)-0.1)
#skmi1<-summary(km1, time=c(3, 6)+0.1)
skmi1<-summary(km1, time=c(1, 3)+0.1) #plus d'Ã©vÃ¨nement apres 3.6 ans

#pour table de survie
skm0 <- summary(km0, time=seq(0, 10, by=1))
skm0 <- data.frame(time=skm0$time, n.risk=skm0$n.risk)
skm1<-summary(km1, time=seq(0, 10, by=1))
skm1 <- data.frame(time=skm1$time, n.risk=skm1$n.risk)


#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend = FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete( labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(1,1,3,2), "cm")) 

#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi0$time[i], y = skmi0$lower[i], xend = skmi0$time[i], yend = skmi0$upper[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$lower[i], xend = skmi0$time[i] + 0.1, yend = skmi0$lower[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$upper[i], xend = skmi0$time[i] + 0.1, yend = skmi0$upper[i])
}
for (i in 1:2) {
   g <- g + geom_segment(x = skmi1$time[i], y = skmi1$lower[i], xend = skmi1$time[i], yend = skmi1$upper[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$lower[i], xend = skmi1$time[i] + 0.1, yend = skmi1$lower[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$upper[i], xend = skmi1$time[i] + 0.1, yend = skmi1$upper[i])
}

#risk table
for (ii in 1:nrow(skm0)) {
  g <- g + annotation_custom(grob = textGrob(skm0$n.risk[ii]), xmin = skm0$time[ii], xmax = skm0$time[ii], ymin= - 1.5 )
}  
for (ii in 1:nrow(skm1)) {
  g <- g + annotation_custom(grob = textGrob(skm1$n.risk[ii]), xmin = skm1$time[ii], xmax = skm1$time[ii], ymin= - 1.7 )
} 
  #display group text
  g <- g + annotation_custom(grob = textGrob(leg[1]), xmin = -1.7, xmax = -1.7, ymin= - 1.5 )
  g <- g + annotation_custom(grob = textGrob(leg[2]), xmin = -1.7, xmax = -1.7, ymin= - 1.7 )
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)
```


### Orthopnee
#### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$orthop
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

L'hypothese des risques proportionnels est verifiee, je peux interpreter.

```{r, echo=FALSE}
summary(mod)
```

Le test du score est non significatif (p>=0.05), le risque de deces n'est pas modifie selon qu'il y a ou non une orthopnee a l'instauration de la vni.

```{r, echo=FALSE, message=FALSE}
var <- "Orthopnee"
km <- survfit(Surv(tps,censor)~orthop, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~orthop, data=s[s$orthop==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~orthop, data=s[s$orthop==1,], conf.int=.95)

#pour IC95%
#skmi0<-summary(km0, time=c(3, 6)-0.1)
skmi0<-summary(km0, time=c(1, 3)-0.1) #plus d'Ã©vÃ¨nement apres 5.2 ans
#skmi1<-summary(km1, time=c(3, 6)+0.1)
skmi1<-summary(km1, time=c(1, 3)+0.1) #plus d'Ã©vÃ¨nement apres 4.6 ans

#pour table de survie
skm0 <- summary(km0, time=seq(0, 10, by=1))
skm0 <- data.frame(time=skm0$time, n.risk=skm0$n.risk)
skm1<-summary(km1, time=seq(0, 10, by=1))
skm1 <- data.frame(time=skm1$time, n.risk=skm1$n.risk)


#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend = FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete( labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(1,1,3,2), "cm")) 

#intervalle de confiance
for (i in 1:2) {
   g <- g + geom_segment(x = skmi0$time[i], y = skmi0$lower[i], xend = skmi0$time[i], yend = skmi0$upper[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$lower[i], xend = skmi0$time[i] + 0.1, yend = skmi0$lower[i])
   g <- g + geom_segment(x = skmi0$time[i] - 0.1, y = skmi0$upper[i], xend = skmi0$time[i] + 0.1, yend = skmi0$upper[i])
}
for (i in 1:2) {
   g <- g + geom_segment(x = skmi1$time[i], y = skmi1$lower[i], xend = skmi1$time[i], yend = skmi1$upper[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$lower[i], xend = skmi1$time[i] + 0.1, yend = skmi1$lower[i])
   g <- g + geom_segment(x = skmi1$time[i] - 0.1, y = skmi1$upper[i], xend = skmi1$time[i] + 0.1, yend = skmi1$upper[i])
}

#risk table
for (ii in 1:nrow(skm0)) {
  g <- g + annotation_custom(grob = textGrob(skm0$n.risk[ii]), xmin = skm0$time[ii], xmax = skm0$time[ii], ymin= - 1.5 )
}  
for (ii in 1:nrow(skm1)) {
  g <- g + annotation_custom(grob = textGrob(skm1$n.risk[ii]), xmin = skm1$time[ii], xmax = skm1$time[ii], ymin= - 1.7 )
} 
  #display group text
  g <- g + annotation_custom(grob = textGrob(leg[1]), xmin = -1.7, xmax = -1.7, ymin= - 1.5 )
  g <- g + annotation_custom(grob = textGrob(leg[2]), xmin = -1.7, xmax = -1.7, ymin= - 1.7 )
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)
```



### LIEUDEB

```{r, echo=FALSE, message=FALSE}
var <- "Lieu deb"
km <- survfit(Surv(tps,censor)~LIEUDEB_recode, data=s, conf.int=.95)

for (i in 1:length(km$strata)){
  .km <- survfit(Surv(tps,censor)~LIEUDEB_recode, data=s[s$LIEUDEB_recode==levels(s$LIEUDEB_recode)[i], ], conf.int=.95)
assign(paste0("km",i), .km)
#pour IC95%
am <- i/10
.skmi <- summary(.km, time=c(1, 3)-am)
assign(paste0("skmi",i), .skmi)
#pour table de survie
.skm <- summary(.km, time=seq(0, 10, by=1))
.skm <- data.frame(time=.skm$time, n.risk=.skm$n.risk)
assign(paste0("skm",i), .skm)
}

#preparation legende
leg<-names(km$strata)

#courbe de survie
g <- ggsurv(km, CI=FALSE, order.legend = FALSE) +
  #changement des axes
  scale_x_continuous(breaks=seq(0,max(s$tps),1), labels=0:(length(seq(0,max(s$tps),1))-1)) +
  scale_y_continuous(labels=percent) +
  labs(x="Time of follow-up, year") +
  #changement legende
  guides (linetype = FALSE) +
  scale_colour_discrete( labels = leg) +
  theme(legend.position="right", legend.title=element_blank()) +
  #espace autour du schÃ©ma
  theme(plot.margin = unit(c(0,1,4,2), "cm")) #top, right, bottom, left

#intervalle de confiance
for (j in 1:5){
  .skmi <- get(paste0(paste0("skmi",j)))
  for (i in 1:2) {
    
    g <- g + geom_segment(x = .skmi$time[i], y = .skmi$lower[i], xend = .skmi$time[i], yend = .skmi$upper[i])
    g <- g + geom_segment(x = .skmi$time[i] - 0.1, y = .skmi$lower[i], xend = .skmi$time[i] + 0.1, yend = .skmi$lower[i])
    g <- g + geom_segment(x = .skmi$time[i] - 0.1, y = .skmi$upper[i], xend = .skmi$time[i] + 0.1, yend = .skmi$upper[i])
  }
}

```

```{r, echo=FALSE}
#risk table
#position_y <- c(-1.2, -1.5, -1.7, -1.9, -2.1)
position_y <- c(-1.4, -1.5, -1.6, -1.7, -1.8)
for (j in 1:5){
    .skm <- get(paste0(paste0("skm",j)))
    .pos <- position_y[j]
  for (ii in 1:nrow(.skm)) {
    g <- g + annotation_custom(grob = textGrob(.skm$n.risk[ii]), xmin = .skm$time[ii], xmax = .skm$time[ii], ymin= .pos )
  } 
}

  #display group text
for (j in 1:5){
  g <- g + annotation_custom(grob = textGrob(str_sub(leg,16,-1)[j]), xmin = -2.1, xmax = -2.1, ymin = position_y[j])
}
  
gt <- ggplotGrob(g)
gt$layout$clip[gt$layout$name=="panel"] <- "off"
grid.draw(gt)
```


#### Recodage en 4 variables binaires

```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001 # au cas ou un temps vaut 0 ce qui empÃªche survsplit de fonctionner
#recodage LIEUDEB en 4 var bianaire. ref = bulbar
s$cerv <- ifelse(s$LIEUDEB_recode=="cervical",1,0)
s$llimb <- ifelse(s$LIEUDEB_recode=="lower limb onset", 1, 0)
s$resp <- ifelse(s$LIEUDEB_recode=="respiratory", 1, 0)
s$ulimb <- ifelse(s$LIEUDEB_recode=="upper limb onset", 1, 0)

#mod <- coxph(Surv(tps, censor) ~ cerv + llimb + resp + ulimb, data = s)

```


#### cervical

##### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001 # au cas ou un temps vaut 0 ce qui empÃªche survsplit de fonctionner
s$cerv <- ifelse(s$LIEUDEB_recode=="cervical",1,0)

s$a_recode <- s$cerv
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi

```
Le debut est significatif => on recode

```{r, echo=FALSE}
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
#slat$at <- slat$a_recode * log(slat$stop) #non graphe mauvais
#slat$at <- slat$a_recode * sqrt(slat$stop) #non graphe mauvais
#slat$at <- slat$a_recode / (slat$stop) #non at non significatif
#slat$at <- slat$a_recode * (slat$stop) #non at non significatif

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

si at significatif => je revÃ©rifie les conditions

```{r, echo=FALSE}
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Aucune correction ne convient, en attendant je garde sans correction car la courbe ne s'Ã©cartait que trÃ¨s peu de beta=0

##### Interpretation
```{r, echo=FALSE}
summary(mod)
```
Pas de risque de deces accru pour lieu de dÃ©but cervical compare a bulbaire (p>=0.05)


#### lower limb

##### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001 # au cas ou un temps vaut 0 ce qui empÃªche survsplit de fonctionner
s$llimb <- ifelse(s$LIEUDEB_recode=="lower limb onset", 1, 0)

s$a_recode <- s$llimb
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi

```
non significatif => on interprete


##### Interpretation
```{r, echo=FALSE}
summary(mod)
```
Pas de risque de deces accru pour lieu de dÃ©but membres inferieurs compare a bulbaire (p>=0.05)

#### repiratory

##### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001 # au cas ou un temps vaut 0 ce qui empÃªche survsplit de fonctionner
s$resp <- ifelse(s$LIEUDEB_recode=="respiratory", 1, 0)

s$a_recode <- s$resp
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi

```
Le debut est significatif => on recode

```{r, echo=FALSE}
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
#slat$at <- slat$a_recode * log(slat$stop) #non graphe pas mal mais 3p signif
#slat$at <- slat$a_recode * sqrt(slat$stop) #non graphe pas mal mais 3p signif
#slat$at <- slat$a_recode / (slat$stop) #non at non significatif
#slat$at <- slat$a_recode * (slat$stop) #non graphe mauvais

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

si at significatif => je revÃ©rifie les conditions

```{r, echo=FALSE}
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Aucune correction ne convient, et l'ecart a l'hypothese avait l'air important.je ne sais pas interpreter en l'etat


#### Membres superieurs

##### Hypothese des risques proportionnels
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001 # au cas ou un temps vaut 0 ce qui empÃªche survsplit de fonctionner
s$ulimb <- ifelse(s$LIEUDEB_recode=="upper limb onset", 1, 0)

s$a_recode <- s$ulimb
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#residus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi

```
Le milieu est significatif => on recode

```{r, echo=FALSE}
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
#slat$at <- slat$a_recode * log(slat$stop) #non at non signif
#slat$at <- slat$a_recode * sqrt(slat$stop) #non at non signif
#slat$at <- slat$a_recode / (slat$stop) #non at non significatif
#slat$at <- slat$a_recode * (slat$stop) #non at non significatif
slat$at<-slat$a_recode*ifelse(slat$stop>=1 & slat$stop<2.5, 1, 0) #at signif, test non signif mais graphe mauvais

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```


```{r, echo=FALSE}
#residus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Aucune correction ne convient, et l'ecart a l'hypothese avait l'air important.je ne sais pas interpreter en l'etat