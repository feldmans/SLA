---
title: "Survie univariée"
output:
  word_document: default
  html_notebook: default
---


```{r allsource, echo=FALSE, message=FALSE}
.dir <- "F:/"
#.dir <-  "d:/"
source(paste0(.dir,"to push/sla_git/src/libraries_SLA.R"))
source(paste0(.dir,"to push/sla_git/src/fonctions_SLA.R"))
```


```{r, echo=FALSE}
sla <- readRDS(paste0(.dir,"to push/sla_git/data/BASE_SLA_allbl.rds"))

sla$rilu <- ifelse (sla$DEBRILU < sla$DATEVNI & (is.na(sla$FINRILU) | sla$FINRILU>sla$DATEVNI), 1, 0) #je fais l'hyp qu'il n'y a pas de NA

sla$keep <- ifelse (sla$DATEVNI<=sla$ddn,1,0)

sla <- sla[sla$keep==1, ]
sla$time.vni <- as.numeric(sla$ddn - sla$DATEVNI)
sla$time.sym <- as.numeric(sla$ddn - sla$FIRSTSYMPTOM)
sla$censor <- ifelse (!is.na(sla$date_dc),1, 0)
#sla$sex <- factor(sla$sex_def, levels=c(1,2), labels=c("h","f") ) #1 = 'Masculin' 2 = 'Féminin'
sla$sex <- ifelse(sla$sex_def==1,0,sla$sex_def) #0 = 'Masculin' 1 = 'Féminin'
sla$sex <- ifelse(sla$sex_def==2,1,sla$sex) #0 = 'Masculin' 1 = 'Féminin'
#sla$sex <- sla$sex_def #1 = 'Masculin' 2 = 'Féminin'
sla$agevni <- round(as.numeric(sla$DATEVNI-sla$DOB)/365.25,0)
sla$rilu <- ifelse(sla$DATEVNI>sla$DEBRILU & !is.na(sla$DEBRILU), 1,0)
sla$rilu <- ifelse(sla$DATEVNI<sla$FINRILU & !is.na(sla$FINRILU), 0,sla$rilu)
sla$familial <- ifelse (is.na(sla$familial),0,sla$familial)
sla$LIEUDEB_recode <- as.factor(sla$LIEUDEB_recode)
#sla$ddn <- ifelse(sla$ddn>as_date("2015-08-27"), as_date("2015-08-27"), sla$ddn) #voir avec Yann

var_bl <- c("familial", "sex", "agevni", "LIEUDEB_recode", "rilu", "dysp","orthop","CVF_ASSIS_perc_pred","CVF_COUCHE_perc_pred","SNIP_cmH2O",
  "SNIP_perc_pred","PIMAX_cmH2O","PIMAX_perc_pred","perc_time_under_spo2_90","time_under_spo2_90_h","bicar","ALS_score","bulb_score")

var_quali <- c("familial", "sex", "LIEUDEB_recode", "rilu", "dysp", "orthop")
var_quanti <- var_bl [! var_bl %in% var_quali]

sla[,var_quanti] <- apply(sla[,var_quanti], 2, function(x) as.numeric(x))
sla[,var_quali[!var_quali%in% "LIEUDEB_recode"]] <- apply(sla[,var_quali[!var_quali%in% "LIEUDEB_recode"]], 2, function(x) as.numeric(x))

#summary(sla)
#str(sla)
```

#Description de la population 
```{r, echo=FALSE}
table_var_quali <- lapply(var_quali, function(i){
  data <- sla[,i]
  names_levels <- levels(as.factor(data))
  a <- lapply(names_levels, function(x) {
    tmp <- as.numeric(table(data)[x])
    tmpbis <- round(as.numeric(prop.table(table(data))[x]),3)*100
    tmptot <- paste0(tmp," (",tmpbis,"%)")
    
    nNA <- table(is.na(data))
    pNA <- round(prop.table(table(is.na(data))),3)
    if (is.na(nNA[2]))  {
      if (which(names_levels==x)==1) nNA <- paste0 (0," (0%)")
      else nNA <- ""
    }
    else {
      if (which(names_levels==x)==1){
        nNA <- as.numeric (nNA[names(nNA)==TRUE])
        pNA <- as.numeric (pNA[names(pNA)==TRUE])*100
        nNA <- paste0(nNA," (",pNA,"%)")  
      }
      else nNA <- ""
    }
    cbind(tmptot,nNA)
      
  })
  a <- do.call(rbind,a)
  #a <- cbind (a,nNA)
  rownames(a) <- paste0(i,"_",names_levels) 
  colnames(a) <- c("valeur","missing values")
  # a <- rbind (a,nNA)
  # rownames(a)[-nrow(a)] <- paste0(i,"_",names_levels) 
  return(a)
})
table_var_quali <- do.call(rbind,table_var_quali)

table_var_quanti <- lapply(var_quanti, function(i){ #median ou moyenne? (sachant qu'on ne vérifie pas normalité des baselines)
  data <- sla[,i]
  med <- round(median (data,na.rm=T),2)
  quant <- round(quantile(data,na.rm=T),2)
  Q1 <- quant[2]
  Q3 <- quant[4]
  a <- paste0(med," (",Q1,"-",Q3,")")
  #browser()

  nNA <- table(is.na(data))
  pNA <- round(prop.table(table(is.na(data))),3)
  if (is.na(nNA[2]))  nNA <- paste0 (0," (0%)")
  else {
    nNA <- as.numeric (nNA[names(nNA)==TRUE])
    pNA <- as.numeric (pNA[names(pNA)==TRUE])*100
    nNA <- paste0(nNA," (",pNA,"%)")
  }
  # a <- rbind (a,nNA)
  # rownames(a)[-nrow(a)] <- paste0(i,"*") 
  a <- cbind (a,nNA)
  rownames(a) <- paste0(i,"*")
  colnames(a) <- c("valeur","missing values")
  return(a)
})
table_var_quanti <- do.call(rbind,table_var_quanti)

table_var <- rbind(table_var_quali,table_var_quanti)
kable(table_var)

```

Table 1 Charactéristiques à baseline (t=debut de la vni)
*variables quantitatives

<1% de données manquantes pour :   
- familial(atcd familiaux de sla oui ou non)   
- sex  
- lieu de début des symptomes  
- a commencé un traitement par riluzole avant vni oui ou non  
- age a l'instauration de la vni   

Environ 30% de données manquantes pour :    
- le score ALS à l'instauration de la VNI  

Environ 50 % de données manquantes pour :  
- orthopnée au moment de l'instauration de la vni  
- dyspnée au moment de l'instauration de la vni   

Plus de 65% de données manquantes pour :  
- CVF assis et couché   
- SNIP en cmH20 ou pourcentage de la théorie   
- PIMAX en cmH20 ou pourcentage de la théorie  
- pourcentage de temps inférieur à 90% de sp02  
- bicarbonates   
- score bulbaire  

64% d'homme   
98% de formes non familiales  
7% de traitement par riluzole  
plus de 50% d'orthopnée mais moins de 25% de dyspnée au repos.  


#VERSION DEBUT = PREMIERS SYMPTOMES


##Suivi global

```{r, echo=FALSE}
#range date de début
deb1 <- range(sla$FIRSTSYMPTOM,na.rm=T)

#repartition des dates de premier symptome
s<-sla[!is.na(sla$time.sym),]
s$tan<-s$time.sym/365.25
s$an<-substring(s$FIRSTSYMPTOM, 1, 4)
#table(s$an)
barplot(table(s$an))
```

Fig.1 Distribution des dates de premier symptome

```{r}
y<-as.numeric(as.Date("01/09/2015", "%d/%m/%Y"))-as.numeric(s$FIRSTSYMPTOM)
hist(y/365.25)
#summary(y/365.25)
```
Fig.2 répartition des durée de suivi

range date de début :  
`r deb1`

La majorité des sujets sont inclus à partir de 2006 (9ans de recul) et quasiment plus d'unclusion en 2011 (4 ans de recul) (Figure 1)

```{r, echo=FALSE, message=FALSE}
#suivi
sym.suiv <- survfit(Surv(time.sym,1-censor)~1,data=s)
an <- paste0 (round(summary(sym.suiv)$table['median']/365.25,2)," [",round(summary(sym.suiv)$table['0.95LCL']/365.25,2),"-",round(summary(sym.suiv)$table['0.95UCL']/365.25,2),"]")

# #idem (Yann)
# suivi<-survfit(Surv(tan, 1-censor)~1, data=s)
# suivi


```
Médiane de suivi (an) : `r an`   

C'est cohérent au vu de la figure 1 et de la figure 2.


## Survie globale
```{r, echo=FALSE}
sym.surv <- survfit(Surv(time.sym,censor)~1, data=s, conf.int=.95)

an <- paste0 (round(summary(sym.surv)$table['median']/365.25,2)," [", round(summary(sym.surv)$table['0.95LCL']/365.25,2), "-", round(summary(sym.surv)$table['0.95UCL']/365.25,2),"]")

plot(sym.surv,xscale=365.25, yscale= 100, xlab="time (years)")
ggsurv(sym.surv) +#https://www.r-bloggers.com/survival-plots-have-never-been-so-informative/
  scale_x_continuous(breaks=seq(0,max(s$time.sym),365.25), labels=0:(length(seq(0,max(s$time.sym),365.25))-1)) +
  scale_y_continuous(labels=percent) 
```


Fig.3 Courbe de survie en fonction du temps 


Médiane de survie (an) : `r an`





#VERSION DEBUT = MISE EN PLACE VNI

##Suivi global

```{r, echo=FALSE}


#repartition des dates de premier symptome
s<-sla[!is.na(sla$time.vni),]
s$tan<-s$time.vni/365.25
s$an<-substring(s$DATEVNI, 1, 4)
#table(s$an)
barplot(table(s$an))
```

Fig.4 Distribution de la date d'instauration de la vni

Centré autour de 2010. majorité des vni entre 2008 et 2012 donc entre 7 ans et 3 ans de recul.


```{r}
#range date de début
deb1 <- range(sla$DATEVNI,na.rm=T)

y<-as.numeric(as.Date("01/09/2015", "%d/%m/%Y"))-as.numeric(s$DATEVNI)
hist(y/365.25)
#summary(y/365.25)
```
Fig.5 répartition des durée de suivi

range date de début :  
`r deb1`


```{r, echo=FALSE, message=FALSE}
#suivi
sym.suiv <- survfit(Surv(time.vni,1-censor)~1,data=s)
an <- paste0 (round(summary(sym.suiv)$table['median']/365.25,2)," [",round(summary(sym.suiv)$table['0.95LCL']/365.25,2),"-",round(summary(sym.suiv)$table['0.95UCL']/365.25,2),"]")

# #idem (Yann)
# suivi<-survfit(Surv(tan, 1-censor)~1, data=s)
# suivi


```
Médiane de suivi (an) : `r an`   

C'est un peu étrange que la médiane de suivi soit si basse, au vu des figures 4 et 5 j'aurais plutôt parié sur une médiane de suivi à 4.5 ans.


## Survie globale
```{r, echo=FALSE}
sym.surv <- survfit(Surv(time.vni,censor)~1, data=s, conf.int=.95)

an <- paste0 (round(summary(sym.surv)$table['median']/365.25,2)," [", round(summary(sym.surv)$table['0.95LCL']/365.25,2), "-", round(summary(sym.surv)$table['0.95UCL']/365.25,2),"]")

plot(sym.surv,xscale=365.25, yscale= 100, xlab="time (years)")
ggsurv(sym.surv) +#https://www.r-bloggers.com/survival-plots-have-never-been-so-informative/
  scale_x_continuous(breaks=seq(0,max(s$time.vni),365.25), labels=0:(length(seq(0,max(s$time.vni),365.25))-1)) +
  scale_y_continuous(labels=percent) 
```

Fig.3 Courbe de survie en fonction du temps 


Médiane de survie (an) : `r an`

```{r, echo=FALSE, eval=FALSE}
#--------------------------
#Yann : rajout de table de survie et d'intervalle de confiance à la main 
s<-sla
s$tps<-s$time.vni/365.25
km <- survfit(Surv(tps,censor)~1, data=s, conf.int=.95)
skmi<-summary(km, time=c(3, 6))
skm<-summary(km, time=seq(0, 10, by=1))
skm

par(mai=c(2,1.5,1.5,.5))
  plot(km, conf=F, col="blue")
  segments(skmi$time, skmi$lower, skmi$time, skmi$upp, col="blue")
  segments(skmi$time-0.1, skmi$lower, skmi$time+0.1, skmi$lower, col="blue")
  segments(skmi$time-0.1, skmi$upp, skmi$time+0.1, skmi$upper, col="blue")
  mtext(side=1, at=skm$time, skm$n.risk, adj=.5, col="blue", line=2, cex=0.75)


s<-sla
s$tps<-s$time.vni/365.25
km <- survfit(Surv(tps,censor)~sex, data=s, conf.int=.95)
km0 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==0,], conf.int=.95)
km1 <- survfit(Surv(tps,censor)~sex, data=s[s$sex==1,], conf.int=.95)
km
skmi0<-summary(km0, time=c(3, 6)-0.1)
skmi1<-summary(km1, time=c(3, 6)+0.1)
skm0<-summary(km0, time=seq(0, 10, by=1))
skm1<-summary(km1, time=seq(0, 10, by=1))
skm

leg<-names(km$strata)
par(mai=c(2,1.5,1.5,.5))
coul<-c("blue", "red")
  plot(km, conf=F, col=coul)
  legend("topright", adj=0, col=coul, leg=leg, lty=1)
  segments(skmi0$time, skmi0$lower, skmi0$time, skmi0$upp, col=coul[1])
  segments(skmi1$time, skmi1$lower, skmi1$time, skmi1$upp, col=coul[2])
  mtext(side=1, at=-0.5, leg[1], col=coul[1], line=2)
  mtext(side=1, at=skm0$time, skm0$n.risk, adj=.5, col=coul[1], line=2, cex=0.75)
  mtext(side=1, at=skm1$time, skm1$n.risk, adj=.5, col=coul[2], line=3, cex=0.75)
#-----------------
```



## Modeles de Cox univarié

Ils seront de la forme 
modcox <- coxph(Surv(time.vni, censor) ~ ALS_score, data = sla) #ALS_score au autre variable baseline

un modele par variable à baseline

### Variables binaires

#### Hypothèse de Loglinéarité

N'a pas de sens pour une variable binaire

#### Hypothèse des risques proportionnels

##### Familial
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$familial
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#résidus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
z <- cox.zph(mod, transform = "rank")
z
```

La représentation graphique des résidus de shoenfeld est non significatif.  
Le test de Harrell est non significatif.  

Conclusion : l'hypothèse des risques proportionnels est vérifiée.

```{r, echo=FALSE}
summary(mod)
```

Je peux donc en déduire que les individus avec un antécédent familial ont un risque de décès multiplié par 2.5  
Pour la significativité je lis test du score?

##### Sexe
```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$sex
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#résidus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

L'hypothèse Nulle de risque proportionnel est rejetée par méthode graphique (pas par le test) entre 6 mois et 1 an et demi environ.  

Je dois rajouter une variable dépendante du temps.

###### Log

```{r, echo=FALSE}
#----- Log -----
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
slat$at <- slat$a_recode * log(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

at est significatif, la correction est peut être bonne.  
Donc je revérifie l'hypothèse des risques proportionnels

```{r, echo=FALSE}
#résidus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
plot(zt[1])
abline(h=0, col="red")
#abline(h=coef(coxt)[1], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Je ne comprends pas le schéma. J'ai 2 schéma, je lis lequel? La courbe est linéaire centrée sur 0 mais droite h=0 pas exactement dans l'IC.
Test significatif mais je lis quelle ligne?

###### sqrt

```{r, echo=FALSE}
#------ sqrt------
slat$at <- slat$a_recode * sqrt(slat$stop)
slat$at1 <- slat$a_recode * ifelse(slat$stop<1, slat$stop, 0) #valeur de la covariable quand tps<1
slat$at2 <- slat$a_recode * ifelse(slat$stop>=1, 1, 0)        #valeur de la covariable qd tps>=1

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
#coxt <- coxph(Surv(start, stop, censor) ~ at1+at2, data=slat)
summary(coxt)$coefficients

#résidus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```
plot à peu près ok...
mais test de harrell significatif pour a_recode et at


###### 1/t
```{r, echo=FALSE}
#--------1/t-----------
slat$at <- slat$a_recode/(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a + at, data=slat)
summary(coxt)$coefficients
#résidus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```
ne fitte pas

###### t
```{r, echo=FALSE}
#----- t -----
slat$at<-slat$a_recode*(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a + at, data=slat)
summary(coxt)$coefficients
#résidus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Fitte moins bien que sqrt

Donc finalement c'est la racine carrée qui fitte le mieux.

```{r, echo=FALSE}
slat$at <- slat$a_recode * sqrt(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)

s <- vcov(coxt)
b <- coef(coxt)
t <- 1
f <- sqrt
var <- s[1,1]+s[2,2]*f(t)^2+2*s[1,2]*f(t)
m <- b[1]+b[2]*f(t)
HR <- round(exp(m),3)
IC <- round(exp(m + qnorm(0.975,m,sqrt(var))*sqrt(var) * c(-1,1)),3)
#IC <- round(exp(m + qnorm(0.975)*sqrt(var) * c(-1,1)),3) #version automatique

#qnorm(c(0.025,0.975), m, sqrt(var)) ??

paste0("HR[95%IC] = ",HR, " [", IC[1], "-", IC[2], "] ", "pour t = ", t, " an" )
```

Je peux donc en déduire que les femmes(a_recode=1) ont un risque de décès significativement différent (a_recode signif) multiplié par :  
- HR = exp(beta(a_recode))= 1,151 à t0  IC=[1.146-1.156] : version calcul à la main
- HR = exp(beta(a_recode) + beta(at) x f(t)) = exp(0.139 + 0.308 * sqrt(1)) = 1.563 à 1 an IC = [1.553-1.572]

Pourquoi l'IC est plus étroit pour t=0 quand on calcule à la main vs lecture de summary? (1,151[1.100-1.204] vs 1.151[1.146-1.156])
parce que le logiciel prend zalpha/2 = 1.96 (qnorm(0.975,0,1))  alors que je prends 0.19 (qnorm(0.975, b[1]+b[2]*f(t), sqrt(var)))


###### Riluzole

```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$rilu
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#résidus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```
L'hypothèse des risques proportionnels est vérifié, je peux interpréter

```{r}
summary(mod)
```
Le risque de décès n'est pas significativement différent selon que les individus sont traités ou non par riluzole. (test du score p=0.848)


###### Dyspnée de repos

```{r, echo=FALSE}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$dysp
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#résidus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

Significatif de 0 à 6 mois environ. J'ajoute une variable dépendante du temps.

###### Log
```{r, echo=FALSE}
s <- s[!is.na(s$a_recode),]

ti <- sort(unique(c(0,s$tps[s$censor==1])))
slat <- s
slat$start <- 0
slat$stop <- slat$tps
slat$evt <- slat$censor
#slat <- survSplit(slat, end="stop", event="evt", start="start",cut=ti) #Yann
slat <- survSplit(Surv(stop,evt)~.,slat,start="start",cut=ti)           #Sarah
slat$at <- slat$a_recode * log(slat$stop)

coxt <- coxph(Surv(start, stop, censor) ~ a_recode + at, data=slat)
summary(coxt)$coefficients
```

at significatif avec log, je revérifie HRR

```{r, echo=FALSE}
#résidus de Shoenfeld
zt <- cox.zph(coxt, transf="identity")
iz<-1 #a_recode
plot(zt[iz])
abline(h=0, col="red")
iz<-2 #at
plot(zt[iz])
abline(h=0, col="red")
#abline(h=coef(coxt)[iz], col="blue")

#Test de Harrell
zit <- cox.zph(coxt, transform = "rank")
zit
```

Le log correspond : courbe à peu près ok et test ok

```{r}
summary(coxt)
```

```{r, echo=FALSE, eval=FALSE}
s <- vcov(coxt)
b <- coef(coxt)
t <- 1
f <- sqrt
var <- s[1,1]+s[2,2]*f(t)^2+2*s[1,2]*f(t)
m <- b[1]+b[2]*f(t)
HR <- round(exp(m),3)
IC <- round(exp(m + qnorm(0.975,m,sqrt(var))*sqrt(var) * c(-1,1)),3)
#IC <- round(exp(m + qnorm(0.975)*sqrt(var) * c(-1,1)),3) #version mean=0, sd=1

#qnorm(c(0.025,0.975), m, sqrt(var)) ??

paste0("HR[95%IC] = ",HR, " [", IC[1], "-", IC[2], "] ", "pour t = ", t, " an" )

```

Le risque de décès n'est pas significativement différent (test du score p>=0.05) selon que le patient ait ou non une dyspnée de repos à l'instauration de la vni.  


###### Orthopnée

```{r}
s <- sla
s$tps <- (s$time.vni/365.25) + 0.001
s$a_recode <- s$orthop
mod <- coxph(Surv(tps, censor) ~ a_recode, data = s)

#résidus de Shoenfeld
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
zi <- cox.zph(mod, transform = "rank")
zi
```

L'hypothèse des risques proportionnels est vérifié, je peux interpréter.

```{r}
summary(mod)
```

Le test du score est non significatif (p>=0.05), le risque de décès n'est pas modifié selon qu'il y a ou non une orthopnée à l'instauration de la vni.


### Variable qualitative non ordonnée

#### Hypothèse de loglinéarité 
non applicable

#### Hypothèse des risques proportionnels

```{r, echo=FALSE}
#résidus de Shoenfeld
mod <- coxph(Surv(time.vni/365.25, censor) ~ LIEUDEB_recode, data = sla)
z <- cox.zph(mod, transf="identity")
plot(z)
abline(h=0, col="red")
abline(h=coef(mod), col="blue")

#Test de Harrell
z <- cox.zph(mod, transform = "rank")
z
```


#si la courbe et le test sont non sgnificatifs, on peut interpréter:
summary(mod)
les femmes (var=1) ont un risque de décès multiplié par exp(beta(var))=exp(coef)= 2.5 (p<0.05)
